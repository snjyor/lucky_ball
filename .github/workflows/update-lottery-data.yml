name: Update Lottery Data

on:
  schedule:
    # æ¯å¤©æ™šä¸Š23ç‚¹è¿è¡Œ (UTC+8æ—¶åŒºï¼Œå¯¹åº”UTCæ—¶é—´15:00)
    - cron: '0 15 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]  # PRåˆå¹¶åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    types: [ closed ]   # åªåœ¨PRå…³é—­æ—¶è§¦å‘

jobs:
  update-data:
    runs-on: ubuntu-latest
    # ç¡®ä¿PRåªåœ¨åˆå¹¶æ—¶è¿è¡Œï¼Œè€Œä¸æ˜¯ç®€å•å…³é—­æ—¶è¿è¡Œ
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: Set up Python
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: Cache pip dependencies
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
          
    - name: Install dependencies
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy matplotlib seaborn beautifulsoup4
        
    - name: Run lottery data analyzer
      run: |
        python lottery_analyzer.py
        
    - name: Check for changes
      id: git-check
      run: |
        git diff --exit-code lottery_data.json analysis_report.md || echo "changed=true" >> $GITHUB_OUTPUT
        
    - name: Commit and push if changed
      if: steps.git-check.outputs.changed == 'true'
      run: |
        git config --local user.email "snjyor@gmail.com"
        git config --local user.name "snjyor"
        git add lottery_data.json
        git add analysis_report.md
        git add lottery_frequency_analysis.png
        git commit -m "ðŸŽ¯ æ›´æ–°åŒè‰²çƒæ•°æ® - $(date +'%Y-%m-%d %H:%M:%S')"
        git push
        
    - name: Create release on major updates
      if: steps.git-check.outputs.changed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # èŽ·å–å½“å‰æ—¥æœŸä½œä¸ºtag
        TAG_NAME="data-$(date +'%Y%m%d')"
        
        # æ£€æŸ¥tagæ˜¯å¦å·²å­˜åœ¨
        if ! git tag | grep -q "^$TAG_NAME$"; then
          # åˆ›å»ºtagå’Œrelease
          git tag $TAG_NAME
          git push origin $TAG_NAME
          
          # åˆ›å»ºrelease notes
          cat > release_notes.md << EOF
        ## ðŸŽ¯ åŒè‰²çƒæ•°æ®æ›´æ–° - $(date +'%Yå¹´%mæœˆ%dæ—¥')
        
        ### ðŸ“Š æœ¬æ¬¡æ›´æ–°å†…å®¹
        - æŠ“å–æœ€æ–°åŒè‰²çƒå¼€å¥–æ•°æ®
        - æ›´æ–°ç»Ÿè®¡åˆ†æžå›¾è¡¨
        - åˆ·æ–°å·ç é¢‘çŽ‡åˆ†æž
        - æ›´æ–°åˆ†æžæŠ¥å‘Šæ–‡æ¡£
        
        ### ðŸ“ æ›´æ–°æ–‡ä»¶
        - \`lottery_data.json\` - æœ€æ–°å¼€å¥–æ•°æ®
        - \`analysis_report.md\` - è¯¦ç»†åˆ†æžæŠ¥å‘Š
        - \`lottery_frequency_analysis.png\` - é¢‘çŽ‡åˆ†æžå›¾è¡¨
        
        ### âš ï¸ å…è´£å£°æ˜Ž
        æœ¬æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç»Ÿè®¡åˆ†æžä½¿ç”¨ï¼Œå½©ç¥¨å¼€å¥–å®Œå…¨éšæœºï¼Œè¯·ç†æ€§è´­å½©ã€‚
        EOF
          
          # ä½¿ç”¨GitHub CLIåˆ›å»ºrelease
          gh release create $TAG_NAME \
            --title "æ•°æ®æ›´æ–° $TAG_NAME" \
            --notes-file release_notes.md \
            lottery_data.json \
            analysis_report.md \
            lottery_frequency_analysis.png
        fi 