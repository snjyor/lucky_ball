name: æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†æžæŠ¥å‘Š

on:
  schedule:
    # æ¯å¤©æ™šä¸Š23:00 (UTC+8) è¿è¡Œï¼Œå¯¹åº” 15:00 UTC
    - cron: '0 15 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]  # PRåˆå¹¶åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    types: [ closed ]   # åªåœ¨PRå…³é—­æ—¶è§¦å‘

jobs:
  update-lottery-data:
    runs-on: ubuntu-latest
    # ç¡®ä¿PRåªåœ¨åˆå¹¶æ—¶è¿è¡Œï¼Œè€Œä¸æ˜¯ç®€å•å…³é—­æ—¶è¿è¡Œ
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy matplotlib seaborn beautifulsoup4 hjson
        
    - name: è¿è¡Œå½©ç¥¨æ•°æ®åˆ†æž
      run: |
        echo "å¼€å§‹è¿è¡Œå½©ç¥¨æ•°æ®åˆ†æž..."
        python main.py
        exit_code=$?
        echo "åˆ†æžå®Œæˆï¼Œé€€å‡ºç : $exit_code"
        
        # ä¸ç®¡æˆåŠŸå¤±è´¥éƒ½ç»§ç»­åˆ°ä¸‹ä¸€æ­¥ï¼Œè®©gitå˜æ›´æ£€æŸ¥æ¥å†³å®šæ˜¯å¦éœ€è¦æäº¤
        # è¿™æ ·å¯ä»¥ç¡®ä¿ï¼š
        # 1. åªæœ‰çœŸæ­£æœ‰æ•°æ®æ›´æ–°æ—¶æ‰ä¼šæäº¤ï¼ˆé€šè¿‡git diffæ£€æŸ¥ï¼‰
        # 2. å³ä½¿éƒ¨åˆ†åˆ†æžå¤±è´¥ï¼ŒæˆåŠŸçš„éƒ¨åˆ†ä»èƒ½æäº¤
        # 3. é¿å…å› ä¸ºæ—§æ–‡ä»¶å­˜åœ¨è€Œè¯¯åˆ¤ä¸ºæˆåŠŸ
        echo "ç»§ç»­åˆ°æ–‡ä»¶å˜æ›´æ£€æŸ¥æ­¥éª¤..."
        
    - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: git-check
      run: |
        echo "æ£€æŸ¥æ–‡ä»¶å˜æ›´..."
        if git diff --exit-code data/ reports/ pics/ > /dev/null 2>&1; then
          echo "æ²¡æœ‰æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "changed=false" >> $GITHUB_OUTPUT
        else
          echo "æ£€æµ‹åˆ°æ–‡ä»¶å˜æ›´"
          echo "changed=true" >> $GITHUB_OUTPUT
          echo "å˜æ›´çš„æ–‡ä»¶:"
          git diff --name-only data/ reports/ pics/ || true
        fi
        
    - name: æäº¤æ›´æ–°
      if: steps.git-check.outputs.changed == 'true'
      run: |
        echo "å‡†å¤‡æäº¤æ–‡ä»¶å˜æ›´..."
        git config --local user.email "snjyor@gmail.com"
        git config --local user.name "snjyor"
        
        # æ£€æŸ¥å¹¶æ·»åŠ å­˜åœ¨çš„æ–‡ä»¶
        [ -d "data" ] && git add data/ || echo "dataç›®å½•ä¸å­˜åœ¨"
        [ -d "reports" ] && git add reports/ || echo "reportsç›®å½•ä¸å­˜åœ¨"  
        [ -d "pics" ] && git add pics/ || echo "picsç›®å½•ä¸å­˜åœ¨"
        
        # æ£€æŸ¥æ˜¯å¦æœ‰æ–‡ä»¶è¢«æ·»åŠ 
        if git diff --cached --quiet; then
          echo "æ²¡æœ‰æ–‡ä»¶éœ€è¦æäº¤"
          exit 0
        fi
        
        # æäº¤å˜æ›´
        commit_message="ðŸŽ¯ æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†æžæŠ¥å‘Š - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        git commit -m "$commit_message"
        git push
        echo "æ–‡ä»¶æäº¤æˆåŠŸ"
        
    - name: åˆ›å»ºé‡å¤§æ›´æ–°çš„å‘å¸ƒç‰ˆæœ¬
      if: steps.git-check.outputs.changed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        echo "å‡†å¤‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬..."
        # èŽ·å–å½“å‰æ—¥æœŸä½œä¸ºtag (ä½¿ç”¨UTC+8æ—¶åŒº)
        TAG_NAME="lottery-data-$(TZ='Asia/Shanghai' date +'%Y%m%d')"
        
        # æ£€æŸ¥tagæ˜¯å¦å·²å­˜åœ¨
        if ! git tag | grep -q "^$TAG_NAME$"; then
          # åˆ›å»ºtagå’Œrelease
          git tag $TAG_NAME
          git push origin $TAG_NAME
          
          # åˆ›å»ºrelease notes
          cat > release_notes.md << EOF
        ## ðŸŽ¯ å½©ç¥¨æ•°æ®æ›´æ–° - $(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥') (UTC+8)
        
        ### ðŸ“Š æœ¬æ¬¡æ›´æ–°å†…å®¹
        - æŠ“å–æœ€æ–°åŒè‰²çƒå’Œå¤§ä¹é€å¼€å¥–æ•°æ®
        - æ›´æ–°ç»Ÿè®¡åˆ†æžå›¾è¡¨
        - åˆ·æ–°å·ç é¢‘çŽ‡åˆ†æž
        - æ›´æ–°åˆ†æžæŠ¥å‘Šæ–‡æ¡£
        
        ### ðŸ“ æ›´æ–°æ–‡ä»¶
        **åŒè‰²çƒæ•°æ®ï¼š**
        - \`data/lottery_data.json\` - åŒè‰²çƒå¼€å¥–æ•°æ®
        - \`data/lottery_aggregated_data.hjson\` - åŒè‰²çƒèšåˆåˆ†æžæ•°æ®
        - \`reports/analysis_report.md\` - åŒè‰²çƒåˆ†æžæŠ¥å‘Š
        - \`pics/lottery_frequency_analysis.png\` - åŒè‰²çƒé¢‘çŽ‡å›¾è¡¨
        
        **å¤§ä¹é€æ•°æ®ï¼š**
        - \`data/super_lotto_data.json\` - å¤§ä¹é€å¼€å¥–æ•°æ®
        - \`data/super_lotto_aggregated_data.hjson\` - å¤§ä¹é€èšåˆåˆ†æžæ•°æ®
        - \`reports/super_lotto_analysis_report.md\` - å¤§ä¹é€åˆ†æžæŠ¥å‘Š
        - \`pics/super_lotto_frequency_analysis.png\` - å¤§ä¹é€é¢‘çŽ‡å›¾è¡¨
        
        ### âš ï¸ å…è´£å£°æ˜Ž
        æœ¬æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç»Ÿè®¡åˆ†æžä½¿ç”¨ï¼Œå½©ç¥¨å¼€å¥–å®Œå…¨éšæœºï¼Œè¯·ç†æ€§è´­å½©ã€‚
        EOF
          
          # å‡†å¤‡è¦ä¸Šä¼ çš„æ–‡ä»¶åˆ—è¡¨ï¼ˆåªä¸Šä¼ å­˜åœ¨çš„æ–‡ä»¶ï¼‰
          upload_files=""
          [ -f "data/lottery_data.json" ] && upload_files="$upload_files data/lottery_data.json"
          [ -f "data/super_lotto_data.json" ] && upload_files="$upload_files data/super_lotto_data.json"
          [ -f "data/lottery_aggregated_data.hjson" ] && upload_files="$upload_files data/lottery_aggregated_data.hjson"
          [ -f "data/super_lotto_aggregated_data.hjson" ] && upload_files="$upload_files data/super_lotto_aggregated_data.hjson"
          [ -f "reports/analysis_report.md" ] && upload_files="$upload_files reports/analysis_report.md"
          [ -f "reports/super_lotto_analysis_report.md" ] && upload_files="$upload_files reports/super_lotto_analysis_report.md"
          [ -f "pics/lottery_frequency_analysis.png" ] && upload_files="$upload_files pics/lottery_frequency_analysis.png"
          [ -f "pics/super_lotto_frequency_analysis.png" ] && upload_files="$upload_files pics/super_lotto_frequency_analysis.png"
          
          # ä½¿ç”¨GitHub CLIåˆ›å»ºreleaseï¼ˆåªä¸Šä¼ å­˜åœ¨çš„æ–‡ä»¶ï¼‰
          if [ -n "$upload_files" ]; then
            gh release create $TAG_NAME \
              --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
              --notes-file release_notes.md \
              $upload_files
            echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼ŒåŒ…å«æ–‡ä»¶: $upload_files"
          else
            gh release create $TAG_NAME \
              --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
              --notes-file release_notes.md
            echo "å‘å¸ƒç‰ˆæœ¬åˆ›å»ºæˆåŠŸï¼Œä½†æ²¡æœ‰æ•°æ®æ–‡ä»¶å¯ä¸Šä¼ "
          fi
        else
          echo "Tag $TAG_NAME å·²å­˜åœ¨ï¼Œè·³è¿‡åˆ›å»ºå‘å¸ƒç‰ˆæœ¬"
        fi
        
    - name: è¾“å‡ºç»“æžœ
      run: |
        if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
          echo "âœ… å½©ç¥¨æ•°æ®å·²æ›´æ–°å¹¶æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
          
          # æ˜¾ç¤ºæ›´æ–°çš„æ–‡ä»¶
          echo "ðŸ“ æ›´æ–°çš„æ–‡ä»¶:"
          [ -f "data/lottery_data.json" ] && echo "  âœ“ åŒè‰²çƒå¼€å¥–æ•°æ®"
          [ -f "data/super_lotto_data.json" ] && echo "  âœ“ å¤§ä¹é€å¼€å¥–æ•°æ®"
          [ -f "reports/analysis_report.md" ] && echo "  âœ“ åŒè‰²çƒåˆ†æžæŠ¥å‘Š"
          [ -f "reports/super_lotto_analysis_report.md" ] && echo "  âœ“ å¤§ä¹é€åˆ†æžæŠ¥å‘Š"
          [ -f "pics/lottery_frequency_analysis.png" ] && echo "  âœ“ åŒè‰²çƒé¢‘çŽ‡å›¾è¡¨"
          [ -f "pics/super_lotto_frequency_analysis.png" ] && echo "  âœ“ å¤§ä¹é€é¢‘çŽ‡å›¾è¡¨"
        else
          echo "â„¹ï¸ å½©ç¥¨æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        fi 