name: æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†æžæŠ¥å‘Š

on:
  schedule:
    # æ¯å¤©æ™šä¸Š23:00 (UTC+8) è¿è¡Œï¼Œå¯¹åº” 15:00 UTC
    - cron: '0 15 * * *'
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨è§¦å‘
  push:
    branches: [ main ]  # æŽ¨é€åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
  pull_request:
    branches: [ main ]  # PRåˆå¹¶åˆ°mainåˆ†æ”¯æ—¶è§¦å‘
    types: [ closed ]   # åªåœ¨PRå…³é—­æ—¶è§¦å‘

jobs:
  update-lottery-data:
    runs-on: ubuntu-latest
    # ç¡®ä¿PRåªåœ¨åˆå¹¶æ—¶è¿è¡Œï¼Œè€Œä¸æ˜¯ç®€å•å…³é—­æ—¶è¿è¡Œ
    if: github.event_name != 'pull_request' || github.event.pull_request.merged == true
    
    steps:
    - name: æ£€å‡ºä»£ç 
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
      
    - name: è®¾ç½®PythonçŽ¯å¢ƒ
      uses: actions/setup-python@v4
      with:
        python-version: '3.11'
        
    - name: ç¼“å­˜pipä¾èµ–
      uses: actions/cache@v3
      with:
        path: ~/.cache/pip
        key: ${{ runner.os }}-pip-${{ hashFiles('requirements.txt') }}
        restore-keys: |
          ${{ runner.os }}-pip-
        
    - name: å®‰è£…ä¾èµ–
      run: |
        python -m pip install --upgrade pip
        pip install requests pandas numpy matplotlib seaborn beautifulsoup4 hjson
        
    - name: è¿è¡Œå½©ç¥¨æ•°æ®åˆ†æž
      run: |
        python main.py
        
    - name: æ£€æŸ¥æ–‡ä»¶å˜æ›´
      id: git-check
      run: |
        git diff --exit-code data/ reports/ pics/ || echo "changed=true" >> $GITHUB_OUTPUT
        
    - name: æäº¤æ›´æ–°
      if: steps.git-check.outputs.changed == 'true'
      run: |
        git config --local user.email "snjyor@gmail.com"
        git config --local user.name "snjyor"
        git add data/
        git add reports/
        git add pics/
        git commit -m "ðŸŽ¯ æ›´æ–°å½©ç¥¨æ•°æ®å’Œåˆ†æžæŠ¥å‘Š - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        git push
        
    - name: åˆ›å»ºé‡å¤§æ›´æ–°çš„å‘å¸ƒç‰ˆæœ¬
      if: steps.git-check.outputs.changed == 'true'
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      run: |
        # èŽ·å–å½“å‰æ—¥æœŸä½œä¸ºtag (ä½¿ç”¨UTC+8æ—¶åŒº)
        TAG_NAME="lottery-data-$(TZ='Asia/Shanghai' date +'%Y%m%d')"
        
        # æ£€æŸ¥tagæ˜¯å¦å·²å­˜åœ¨
        if ! git tag | grep -q "^$TAG_NAME$"; then
          # åˆ›å»ºtagå’Œrelease
          git tag $TAG_NAME
          git push origin $TAG_NAME
          
          # åˆ›å»ºrelease notes
          cat > release_notes.md << EOF
        ## ðŸŽ¯ å½©ç¥¨æ•°æ®æ›´æ–° - $(TZ='Asia/Shanghai' date +'%Yå¹´%mæœˆ%dæ—¥') (UTC+8)
        
        ### ðŸ“Š æœ¬æ¬¡æ›´æ–°å†…å®¹
        - æŠ“å–æœ€æ–°åŒè‰²çƒå’Œå¤§ä¹é€å¼€å¥–æ•°æ®
        - æ›´æ–°ç»Ÿè®¡åˆ†æžå›¾è¡¨
        - åˆ·æ–°å·ç é¢‘çŽ‡åˆ†æž
        - æ›´æ–°åˆ†æžæŠ¥å‘Šæ–‡æ¡£
        
        ### ðŸ“ æ›´æ–°æ–‡ä»¶
        **åŒè‰²çƒæ•°æ®ï¼š**
        - \`data/lottery_data.json\` - åŒè‰²çƒå¼€å¥–æ•°æ®
        - \`data/lottery_aggregated_data.hjson\` - åŒè‰²çƒèšåˆåˆ†æžæ•°æ®
        - \`reports/analysis_report.md\` - åŒè‰²çƒåˆ†æžæŠ¥å‘Š
        - \`pics/lottery_frequency_analysis.png\` - åŒè‰²çƒé¢‘çŽ‡å›¾è¡¨
        
        **å¤§ä¹é€æ•°æ®ï¼š**
        - \`data/super_lotto_data.json\` - å¤§ä¹é€å¼€å¥–æ•°æ®
        - \`data/super_lotto_aggregated_data.hjson\` - å¤§ä¹é€èšåˆåˆ†æžæ•°æ®
        - \`reports/super_lotto_analysis_report.md\` - å¤§ä¹é€åˆ†æžæŠ¥å‘Š
        - \`pics/super_lotto_frequency_analysis.png\` - å¤§ä¹é€é¢‘çŽ‡å›¾è¡¨
        
        ### âš ï¸ å…è´£å£°æ˜Ž
        æœ¬æ•°æ®ä»…ä¾›å­¦ä¹ å’Œç»Ÿè®¡åˆ†æžä½¿ç”¨ï¼Œå½©ç¥¨å¼€å¥–å®Œå…¨éšæœºï¼Œè¯·ç†æ€§è´­å½©ã€‚
        EOF
          
          # ä½¿ç”¨GitHub CLIåˆ›å»ºrelease
          gh release create $TAG_NAME \
            --title "å½©ç¥¨æ•°æ®æ›´æ–° $TAG_NAME" \
            --notes-file release_notes.md \
            data/lottery_data.json \
            data/super_lotto_data.json \
            data/lottery_aggregated_data.hjson \
            data/super_lotto_aggregated_data.hjson \
            reports/analysis_report.md \
            reports/super_lotto_analysis_report.md \
            pics/lottery_frequency_analysis.png \
            pics/super_lotto_frequency_analysis.png
        fi
        
    - name: è¾“å‡ºç»“æžœ
      run: |
        if [ "${{ steps.git-check.outputs.changed }}" == "true" ]; then
          echo "âœ… å½©ç¥¨æ•°æ®å·²æ›´æ–°å¹¶æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        else
          echo "â„¹ï¸ å½©ç¥¨æ•°æ®æ— å˜åŒ–ï¼Œè·³è¿‡æäº¤ - $(TZ='Asia/Shanghai' date +'%Y-%m-%d %H:%M:%S') (UTC+8)"
        fi 